<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyGo Tracker - Full Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #video { width: 100%; border-radius: 1.5rem; background: #0f172a; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-20">

    <header class="bg-white shadow-sm p-4 sticky top-0 z-50 border-b border-slate-100">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="https://i.ibb.co/XfXkXQy/Easy-Go-Logo.jpg" alt="EasyGo" class="h-12 w-12 rounded-full border-2 border-blue-500">
                <h1 class="text-xl font-black text-slate-900 tracking-tight">EasyGo <span class="text-blue-600">Tracker</span></h1>
            </div>
            <button onclick="exportFilteredJSON()" class="bg-blue-600 text-white text-[10px] px-4 py-2 rounded-xl font-bold uppercase shadow-lg shadow-blue-100 active:scale-95 transition-all">Export JSON</button>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-6">
        
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 text-center">Cash Flow Trend</p>
                <div class="h-44"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 text-center">Expense Categories</p>
                <div class="h-44"><canvas id="pieChart"></canvas></div>
            </div>
        </section>

        <section class="relative bg-slate-900 rounded-[2rem] overflow-hidden shadow-2xl border-4 border-white">
            <video id="video" autoplay playsinline></video>
            <div class="absolute bottom-6 left-0 right-0 flex justify-center gap-4">
                <button onclick="startCamera()" class="bg-white/10 backdrop-blur-xl text-white px-5 py-2.5 rounded-full text-xs font-bold border border-white/20">Open Camera</button>
                <button onclick="captureImage()" class="bg-white h-16 w-16 rounded-full border-4 border-blue-600 flex items-center justify-center shadow-2xl active:scale-90 transition-transform">
                    <div class="h-10 w-10 bg-blue-600 rounded-full"></div>
                </button>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
        </section>

        <div class="flex gap-2 overflow-x-auto no-scrollbar py-2">
            <button onclick="setFilter('today')" class="px-5 py-2.5 bg-white border border-slate-200 rounded-full text-[10px] font-black uppercase whitespace-nowrap shadow-sm">Today</button>
            <button onclick="setFilter('month')" class="px-5 py-2.5 bg-white border border-slate-200 rounded-full text-[10px] font-black uppercase whitespace-nowrap shadow-sm">This Month</button>
            <button onclick="setFilter('6months')" class="px-5 py-2.5 bg-white border border-slate-200 rounded-full text-[10px] font-black uppercase whitespace-nowrap shadow-sm">6 Months</button>
            <button onclick="setFilter('annual')" class="px-5 py-2.5 bg-blue-600 text-white rounded-full text-[10px] font-black uppercase whitespace-nowrap shadow-md">Annual</button>
        </div>

        <section class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <select id="type" class="p-4 bg-slate-50 rounded-2xl font-bold text-xs border-none">
                    <option value="Spent">ðŸ”´ Spent</option>
                    <option value="Earned">ðŸŸ¢ Earned</option>
                </select>
                <select id="category" class="p-4 bg-slate-50 rounded-2xl font-bold text-xs border-none">
                    <option value="Inventory">Inventory</option>
                    <option value="Rent">Rent</option>
                    <option value="Salary">Salary</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Sales">Sales (Income)</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <input type="text" id="itemName" placeholder="Item Name / Description" class="w-full p-4 bg-slate-50 rounded-2xl text-xs border-none outline-none focus:ring-2 focus:ring-blue-500">
            <div class="grid grid-cols-3 gap-3">
                <input type="number" id="qty" value="1" oninput="calcTotal()" placeholder="Qty" class="p-4 bg-slate-50 rounded-2xl text-xs text-center border-none">
                <input type="number" id="perCost" oninput="calcTotal()" placeholder="Cost" class="p-4 bg-slate-50 rounded-2xl text-xs text-center border-none">
                <div id="totalDisplay" class="p-4 bg-blue-50 text-blue-700 rounded-2xl font-black text-xs text-center flex items-center justify-center">$0.00</div>
            </div>
            <button onclick="saveRecord()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl active:scale-[0.98] transition-all uppercase tracking-widest text-xs">Save Bill Record</button>
        </section>

        <div id="history" class="space-y-3"></div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('easygo_v2')) || [];
        let capturedBase64 = null;
        let currentFilter = 'annual';
        let lineChart = null;
        let doughnutChart = null;
        const video = document.getElementById('video');

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (err) { alert("Camera Permission Required"); }
        }

        async function captureImage() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300; canvas.height = 400;
            ctx.drawImage(video, 0, 0, 300, 400);
            capturedBase64 = canvas.toDataURL('image/webp', 0.12); // Targeting 12KB
            alert("Bill Scanned!");
        }

        function calcTotal() {
            const q = document.getElementById('qty').value || 0;
            const p = document.getElementById('perCost').value || 0;
            document.getElementById('totalDisplay').innerText = "$" + (q * p).toFixed(2);
        }

        function saveRecord() {
            const record = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                item: document.getElementById('itemName').value || "Unnamed Bill",
                qty: document.getElementById('qty').value,
                total: parseFloat(document.getElementById('qty').value * document.getElementById('perCost').value) || 0,
                img: capturedBase64
            };
            db.push(record);
            localStorage.setItem('easygo_v2', JSON.stringify(db));
            capturedBase64 = null;
            document.getElementById('itemName').value = "";
            document.getElementById('perCost').value = "";
            render();
        }

        function setFilter(f) { currentFilter = f; render(); }

        function getFilteredData() {
            const now = new Date();
            return db.filter(i => {
                const d = new Date(i.date);
                if (currentFilter === 'today') return d.toDateString() === now.toDateString();
                if (currentFilter === 'month') return d.getMonth() === now.getMonth();
                if (currentFilter === '6months') return d >= new Date().setMonth(now.getMonth() - 6);
                return true;
            });
        }

        function updateCharts() {
            const data = getFilteredData();
            const labels = [];
            const spentArr = [];
            const earnArr = [];
            
            for(let i=5; i>=0; i--) {
                const d = new Date(); d.setMonth(d.getMonth() - i);
                labels.push(d.toLocaleString('default', { month: 'short' }));
                spentArr.push(db.filter(x => x.type === 'Spent' && new Date(x.date).getMonth() === d.getMonth()).reduce((s, x) => s + x.total, 0));
                earnArr.push(db.filter(x => x.type === 'Earned' && new Date(x.date).getMonth() === d.getMonth()).reduce((s, x) => s + x.total, 0));
            }

            if(lineChart) lineChart.destroy();
            lineChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: { labels, datasets: [
                    { label: 'In', data: earnArr, borderColor: '#16a34a', tension: 0.4, borderWidth: 3, pointRadius: 0 },
                    { label: 'Out', data: spentArr, borderColor: '#dc2626', tension: 0.4, borderWidth: 3, pointRadius: 0 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } } }
            });

            const cats = {};
            data.filter(x => x.type === 'Spent').forEach(x => cats[x.category] = (cats[x.category] || 0) + x.total);
            if(doughnutChart) doughnutChart.destroy();
            doughnutChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 8 } } } } }
            });
        }

        function render() {
            const container = document.getElementById('history');
            const filtered = getFilteredData();
            container.innerHTML = '';
            filtered.reverse().forEach(item => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl flex items-center gap-4 border border-slate-100 shadow-sm transition-all active:scale-95">
                        ${item.img ? `<img src="${item.img}" class="w-12 h-12 rounded-xl object-cover shadow-inner">` : `<div class="w-12 h-12 bg-slate-50 rounded-xl"></div>`}
                        <div class="flex-1 min-w-0">
                            <h4 class="font-black text-sm truncate">${item.item}</h4>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">${item.category} â€¢ QTY: ${item.qty}</p>
                        </div>
                        <p class="font-black text-sm ${item.type === 'Earned' ? 'text-green-600' : 'text-red-500'}">$${item.total.toFixed(2)}</p>
                    </div>`;
            });
            updateCharts();
        }

        function exportFilteredJSON() {
            const blob = new Blob([JSON.stringify(getFilteredData(), null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `EasyGo_Report.json`; a.click();
        }

        render();
    </script>
</body>
</html>
