<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyGo Tracker - Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <header class="bg-white shadow-sm p-4 sticky top-0 z-50">
        <div class="max-w-xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2">
                <img src="https://i.ibb.co/XfXkXQy/Easy-Go-Logo.jpg" alt="Logo" class="h-10 w-10 rounded-full border">
                <h1 class="text-lg font-black text-blue-600 tracking-tight">EasyGo</h1>
            </div>
            <button onclick="exportFilteredJSON()" class="bg-blue-600 text-white text-[10px] px-3 py-2 rounded-lg font-bold uppercase shadow-lg shadow-blue-100">Export JSON</button>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-4 pb-24">
        
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm">
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-3 text-center">6-Month Cash Flow</p>
                <div class="h-40"><canvas id="dualTrendChart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm">
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-3 text-center">Spending by Category</p>
                <div class="h-40"><canvas id="categoryChart"></canvas></div>
            </div>
        </section>

        <section class="bg-black rounded-3xl overflow-hidden relative shadow-2xl border-4 border-white" id="video-container">
            <video id="video" autoplay playsinline class="bg-slate-900 min-h-[180px] aspect-video object-cover"></video>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                <button onclick="startCamera()" class="bg-white/20 backdrop-blur-md text-white px-4 py-2 rounded-full text-xs font-bold border border-white/30">Open Camera</button>
                <button onclick="captureImage()" class="bg-white h-12 w-12 rounded-full border-4 border-blue-500 flex items-center justify-center active:scale-90 shadow-xl">
                    <div class="h-8 w-8 bg-blue-500 rounded-full"></div>
                </button>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
        </section>

        <section class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm space-y-3">
            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="setFilter('today')" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-full text-[9px] font-black uppercase whitespace-nowrap">Today</button>
                <button onclick="setFilter('month')" class="px-4 py-2 bg-slate-50 text-slate-500 rounded-full text-[9px] font-black uppercase whitespace-nowrap">Month</button>
                <button onclick="setFilter('6months')" class="px-4 py-2 bg-slate-50 text-slate-500 rounded-full text-[9px] font-black uppercase whitespace-nowrap">6 Months</button>
                <button onclick="setFilter('annual')" class="px-4 py-2 bg-slate-50 text-slate-500 rounded-full text-[9px] font-black uppercase whitespace-nowrap">Annual</button>
            </div>
        </section>

        <section class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm space-y-3">
            <div class="grid grid-cols-2 gap-2">
                <select id="type" class="p-3 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-xs">
                    <option value="Spent">ðŸ”´ Spent</option>
                    <option value="Earned">ðŸŸ¢ Earned</option>
                </select>
                <select id="category" class="p-3 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-xs">
                    <option value="Inventory">Inventory</option>
                    <option value="Rent">Rent</option>
                    <option value="Salary">Salary</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Marketing">Marketing</option>
                    <option value="General">General / Other</option>
                    <option value="Sales">Sales (Income)</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="itemName" placeholder="Item Name" class="p-3 border border-slate-100 rounded-2xl text-xs outline-none">
                <input type="date" id="entryDate" class="p-3 bg-slate-50 border border-slate-100 rounded-2xl text-xs">
            </div>
            <div class="grid grid-cols-3 gap-2">
                <input type="number" id="qty" placeholder="Qty" value="1" oninput="calcTotal()" class="p-3 border border-slate-100 rounded-2xl text-xs text-center">
                <input type="number" id="perCost" placeholder="Cost" oninput="calcTotal()" class="p-3 border border-slate-100 rounded-2xl text-xs text-center">
                <input type="number" id="total" placeholder="Total" readonly class="p-3 bg-blue-50 border border-blue-100 rounded-2xl font-black text-blue-600 text-xs text-center">
            </div>
            <button onclick="saveRecord()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all uppercase tracking-widest text-xs">Save Entry</button>
        </section>

        <div id="history" class="space-y-2 max-h-[400px] overflow-y-auto pr-1"></div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('easygo_data')) || [];
        let capturedBase64 = null;
        let currentFilter = 'annual';
        let lineChart = null;
        let pieChart = null;
        const video = document.getElementById('video');

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (err) { alert("Camera Error"); }
        }

        async function captureImage() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300; canvas.height = 400;
            ctx.drawImage(video, 0, 0, 300, 400);
            capturedBase64 = canvas.toDataURL('image/webp', 0.12); // ~12KB
            alert("Bill Captured!");
        }

        function calcTotal() {
            const q = document.getElementById('qty').value || 0;
            const p = document.getElementById('perCost').value || 0;
            document.getElementById('total').value = (q * p).toFixed(2);
        }

        function saveRecord() {
            const record = {
                id: Date.now(),
                date: document.getElementById('entryDate').value || new Date().toISOString().split('T')[0],
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                item: document.getElementById('itemName').value || "Unnamed",
                qty: document.getElementById('qty').value,
                cost: document.getElementById('perCost').value,
                total: parseFloat(document.getElementById('total').value),
                img: capturedBase64
            };
            db.push(record);
            localStorage.setItem('easygo_data', JSON.stringify(db));
            capturedBase64 = null;
            render();
        }

        function setFilter(type) { currentFilter = type; render(); }

        function getFilteredData() {
            const now = new Date();
            return db.filter(item => {
                const d = new Date(item.date);
                if (currentFilter === 'today') return d.toDateString() === now.toDateString();
                if (currentFilter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                if (currentFilter === '6months') return d >= new Date().setMonth(now.getMonth() - 6);
                return d >= new Date().setFullYear(now.getFullYear() - 1);
            });
        }

        function updateCharts() {
            const filtered = getFilteredData();
            
            // 1. Line Chart Logic (Trend)
            const labels = [];
            const spentData = [];
            const earnedData = [];
            for(let i=5; i>=0; i--) {
                const d = new Date(); d.setMonth(d.getMonth() - i);
                labels.push(d.toLocaleString('default', { month: 'short' }));
                spentData.push(db.filter(x => x.type === 'Spent' && new Date(x.date).getMonth() === d.getMonth()).reduce((s, x) => s + x.total, 0));
                earnedData.push(db.filter(x => x.type === 'Earned' && new Date(x.date).getMonth() === d.getMonth()).reduce((s, x) => s + x.total, 0));
            }

            if(lineChart) lineChart.destroy();
            lineChart = new Chart(document.getElementById('dualTrendChart'), {
                type: 'line',
                data: { labels, datasets: [
                    { label: 'In', data: earnedData, borderColor: '#16a34a', tension: 0.4, borderWidth: 2, pointRadius: 0 },
                    { label: 'Out', data: spentData, borderColor: '#dc2626', tension: 0.4, borderWidth: 2, pointRadius: 0 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { font: { size: 8 } } } } }
            });

            // 2. Pie Chart Logic (Categories)
            const catTotals = {};
            filtered.filter(x => x.type === 'Spent').forEach(x => {
                catTotals[x.category] = (catTotals[x.category] || 0) + x.total;
            });

            if(pieChart) pieChart.destroy();
            pieChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catTotals),
                    datasets: [{
                        data: Object.values(catTotals),
                        backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#64748b']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 8, font: { size: 8 } } } } }
            });
        }

        function render() {
            const container = document.getElementById('history');
            const filtered = getFilteredData();
            container.innerHTML = '';
            filtered.reverse().forEach(item => {
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-2xl flex items-center gap-3 border border-slate-100 mb-2 shadow-sm">
                        ${item.img ? `<img src="${item.img}" class="w-10 h-10 rounded-lg object-cover">` : `<div class="w-10 h-10 bg-slate-50 rounded-lg"></div>`}
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-xs truncate">${item.item}</h4>
                            <p class="text-[8px] text-slate-400 font-bold uppercase">${item.category} | ${item.date}</p>
                        </div>
                        <p class="font-black text-xs ${item.type === 'Earned' ? 'text-green-600' : 'text-red-500'}">$${item.total.toFixed(2)}</p>
                    </div>`;
            });
            updateCharts();
        }

        function exportFilteredJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(getFilteredData()));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `EasyGo_Data.json`); dl.click();
        }

        document.getElementById('entryDate').valueAsDate = new Date();
        render();
    </script>
</body>
</html>
